apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: watchdog-reboot-test
  namespace: default
  labels:
    app: sbd-destructive-test
    test-type: watchdog-reboot
  annotations:
    description: "DESTRUCTIVE TEST: This DaemonSet will cause the target node to REBOOT via watchdog timeout"
spec:
  # DaemonSet will create one pod per matching node
  selector:
    matchLabels:
      app: sbd-destructive-test
      test-type: watchdog-reboot
  template:
    metadata:
      labels:
        app: sbd-destructive-test
        test-type: watchdog-reboot
    spec:
      # WARNING: This pod will cause the node to REBOOT!
      restartPolicy: Always
      
      # Target specific node for testing using nodeSelector
      nodeSelector:
        kubernetes.io/hostname: "ip-10-0-4-98.ap-southeast-2.compute.internal"
      
      # Required for accessing watchdog device and triggering reboot
      hostPID: true
      hostNetwork: true
      
      # Use init container for one-time execution (like medik8s pattern)
      initContainers:
      - name: watchdog-reboot-init
        image: quay.io/medik8s/sbd-destructive-tests:latest
        imagePullPolicy: Always
        
        # Use nsenter to access host mount namespace and run watchdog commands directly
        command:
        - nsenter
        - --mount=/proc/1/ns/mnt
        - --
        - sh
        - -c
        - |
          echo "=== WATCHDOG REBOOT TEST STARTING ==="
          echo "Node: $(hostname)"
          echo "Time: $(date)"
          echo "This test will activate watchdog and stop petting it!"
          echo "=================================================="
          
          # Check if watchdog device exists, if not try to load softdog
          if [ ! -e /dev/watchdog ]; then
            echo "Hardware watchdog not found, attempting to load softdog module..."
            modprobe softdog || echo "Failed to load softdog module"
            sleep 2
          fi
          
          # Check again after potential module load
          if [ ! -e /dev/watchdog ]; then
            echo "ERROR: No watchdog device available!"
            echo "Available devices in /dev:"
            ls -la /dev/watchdog* 2>/dev/null || echo "No watchdog devices found"
            echo "Loaded watchdog modules:"
            lsmod | grep -i watchdog || echo "No watchdog modules loaded"
            echo "Trying to create softdog device manually..."
            
            # Try manual device creation as fallback
            major=$(grep watchdog /proc/devices 2>/dev/null | awk '{print $1}')
            if [ -n "$major" ]; then
              echo "Creating /dev/watchdog with major number $major"
              mknod /dev/watchdog c $major 0 2>/dev/null || echo "Failed to create device node"
            fi
          fi
          
          # Final check
          if [ ! -e /dev/watchdog ]; then
            echo "FATAL: Cannot create or access watchdog device"
            echo "This environment may not support watchdog functionality"
            exit 1
          fi
          
          echo "Found watchdog device: /dev/watchdog"
          echo "Starting 10-second delay before watchdog test..."
          
          # Shorter countdown for watchdog test
          for i in $(seq 10 -1 1); do
            echo "Starting watchdog test in $i seconds..."
            sleep 1
          done
          
          echo "OPENING WATCHDOG DEVICE - THIS WILL ACTIVATE THE WATCHDOG!"
          echo "Petting watchdog 5 times with 3-second intervals..."
          
          # Open watchdog and pet it multiple times
          exec 3>/dev/watchdog
          for i in $(seq 1 5); do
            echo "Pet $i/5 - Writing to watchdog..."
            echo "1" >&3
            sleep 3
          done
          
          echo "STOPPING WATCHDOG PETTING - NODE SHOULD REBOOT SOON!"
          echo "Watchdog timeout will trigger automatic reboot..."
          
          # Close the watchdog (this should trigger reboot countdown)
          exec 3>&-
          
          # Wait and watch (typical softdog timeout is 60 seconds)
          echo "Waiting for watchdog timeout to trigger reboot..."
          for i in $(seq 1 90); do
            echo "Waiting for reboot... ${i}s"
            sleep 1
          done
          
          echo "ERROR: Watchdog did not trigger reboot within expected time"
        
        # Required security context
        securityContext:
          privileged: true
          runAsUser: 0
          capabilities:
            add:
            - SYS_BOOT    # Required for reboot capabilities
            - SYS_ADMIN   # Required for system administration
        
        # Set NODE_NAME environment variable
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        
        # Resource limits
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        
        # Volume mounts for accessing host devices
        volumeMounts:
        - name: host-dev
          mountPath: /dev
        - name: host-root
          mountPath: /host
          readOnly: true
          
      # Main container just sleeps (DaemonSet needs a running container)
      containers:
      - name: sleeper
        image: registry.redhat.io/ubi9/ubi-minimal:latest
        command: ["/bin/sleep", "infinity"]
        securityContext:
          runAsUser: 1001
        resources:
          requests:
            memory: "32Mi"
            cpu: "50m"
          limits:
            memory: "64Mi"
            cpu: "100m"
                  
      volumes:
      - name: host-dev
        hostPath:
          path: /dev
          type: Directory
      - name: host-root
        hostPath:
          path: /
          type: Directory
          
      # Tolerations to run on any node
      tolerations:
      - operator: Exists
        effect: NoSchedule
      - operator: Exists
        effect: NoExecute
        
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: watchdog-test-instructions
  namespace: default
data:
  README.md: |
    # WATCHDOG REBOOT TEST (DaemonSet Pattern)
    
    ⚠️  **EXTREMELY DANGEROUS - WILL REBOOT THE TARGET NODE** ⚠️
    
    ## What this test does:
    1. Uses DaemonSet pattern (like medik8s self-node-remediation)
    2. Runs init container with nsenter --mount=/proc/1/ns/mnt
    3. Opens the kernel watchdog device (/dev/watchdog)
    4. Pets the watchdog 10 times with 3-second intervals
    5. Stops petting the watchdog and waits
    6. The watchdog timeout should trigger an immediate reboot
    
    ## How watchdog works:
    - Opening /dev/watchdog activates the kernel watchdog
    - Writing to the device "pets" it and resets the timeout
    - If the watchdog isn't petted within the timeout period, the kernel reboots
    - Typical timeout is 60 seconds
    
    ## Key Improvements:
    - **DaemonSet instead of Pod**: Ensures proper node targeting
    - **nsenter pattern**: Proven method used by medik8s operators
    - **Init container**: One-time execution pattern
    - **hostPID: true**: Essential for host namespace access
    
    ## Before running:
    1. Edit watchdog-reboot-test.yaml and set ip-10-0-4-98.ap-southeast-2.compute.internal
    2. Ensure the target node can be safely rebooted
    3. Verify /dev/watchdog exists on the target node
    4. Save all work on other nodes
    5. Have monitoring in place to verify the reboot occurs
    
    ## To run:
    kubectl apply -f watchdog-reboot-test.yaml
    
    ## To monitor:
    kubectl logs -f daemonset/watchdog-reboot-test -c watchdog-reboot-init
    
    ## Expected behavior:
    - DaemonSet creates pod on target node
    - Init container runs nsenter and accesses /dev/watchdog
    - Pets the watchdog 10 times over 30 seconds
    - Stops petting and waits
    - Node should reboot within 60 seconds (typical watchdog timeout)
    - Pod will be terminated as the node goes down
    
    ## Troubleshooting:
    - If /dev/watchdog doesn't exist, the hardware watchdog may not be available
    - If the test doesn't cause a reboot, the watchdog may not be working
    - Check dmesg for watchdog-related messages
    
    ## To cleanup after test:
    kubectl delete daemonset watchdog-reboot-test 