apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: panic-reboot-test
  namespace: default
  labels:
    app: sbd-destructive-test
    test-type: panic-reboot
  annotations:
    description: "DESTRUCTIVE TEST: This DaemonSet will cause the target node to REBOOT via nsenter"
spec:
  # DaemonSet will create one pod per matching node
  selector:
    matchLabels:
      app: sbd-destructive-test
      test-type: panic-reboot
  template:
    metadata:
      labels:
        app: sbd-destructive-test
        test-type: panic-reboot
    spec:
      # WARNING: This pod will cause the node to REBOOT!
      restartPolicy: Always
      
      # Target specific node for testing using nodeSelector
      nodeSelector:
        kubernetes.io/hostname: "ip-10-0-4-98.ap-southeast-2.compute.internal"
      
      # Required for accessing host namespace and triggering reboot
      hostPID: true
      hostNetwork: true
      
      # Use init container for one-time execution (like medik8s pattern)
      initContainers:
      - name: panic-reboot-init
        image: quay.io/medik8s/sbd-destructive-tests:latest
        imagePullPolicy: Always
        
        # Use nsenter to access host mount namespace and run reboot commands directly
        command:
        - nsenter
        - --mount=/proc/1/ns/mnt
        - --
        - sh
        - -c
        - |
          echo "=== PANIC REBOOT TEST STARTING ==="
          echo "Node: $(hostname)"
          echo "Time: $(date)"
          echo "This test will REBOOT the node in 30 seconds!"
          echo "====================================="
          
          # 30 second countdown
          for i in $(seq 30 -1 1); do
            echo "Reboot in $i seconds..."
            sleep 1
          done
          
          echo "TRIGGERING SYSTEM REBOOT NOW - NODE SHOULD REBOOT!"
          echo "Attempting emergency reboot via systemctl..."
          
          # Try multiple reboot methods (like our Go version)
          systemctl reboot --force --force || \
          reboot -f || \
          echo b > /proc/sysrq-trigger
        
        # Required security context
        securityContext:
          privileged: true
          runAsUser: 0
          capabilities:
            add:
            - SYS_BOOT    # Required for reboot capabilities
            - SYS_ADMIN   # Required for system administration
        
        # Set NODE_NAME environment variable
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        
        # Resource limits
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        
        # Volume mounts for host access
        volumeMounts:
        - name: host-root
          mountPath: /host
          readOnly: true
          
      # Main container just sleeps (DaemonSet needs a running container)
      containers:
      - name: sleeper
        image: registry.redhat.io/ubi9/ubi-minimal:latest
        command: ["/bin/sleep", "infinity"]
        securityContext:
          runAsUser: 1001
        resources:
          requests:
            memory: "32Mi"
            cpu: "50m"
          limits:
            memory: "64Mi"
            cpu: "100m"
                  
      volumes:
      - name: host-root
        hostPath:
          path: /
          type: Directory
          
      # Tolerations to run on any node
      tolerations:
      - operator: Exists
        effect: NoSchedule
      - operator: Exists
        effect: NoExecute
        
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: panic-test-instructions
  namespace: default
data:
  README.md: |
    # PANIC REBOOT TEST (DaemonSet Pattern)
    
    ⚠️  **EXTREMELY DANGEROUS - WILL REBOOT THE TARGET NODE** ⚠️
    
    ## What this test does:
    1. Uses DaemonSet pattern (like medik8s self-node-remediation)
    2. Runs init container with nsenter --mount=/proc/1/ns/mnt
    3. Executes panic-reboot-test binary with 30-second delay
    4. Should trigger an immediate reboot of the target node
    
    ## Key Improvements:
    - **DaemonSet instead of Pod**: Ensures proper node targeting
    - **nsenter pattern**: Proven method used by medik8s operators
    - **Init container**: One-time execution pattern
    - **hostPID: true**: Essential for host namespace access
    
    ## Before running:
    1. Ensure the target node can be safely rebooted
    2. Save all work on other nodes
    3. Have monitoring in place to verify the reboot occurs
    
    ## To run:
    kubectl apply -f panic-reboot-test.yaml
    
    ## To monitor:
    kubectl logs -f daemonset/panic-reboot-test -c panic-reboot-init
    
    ## Expected behavior:
    - DaemonSet creates pod on target node
    - Init container runs nsenter and executes reboot test
    - Node should reboot immediately when init container completes
    - Pod will be terminated as the node goes down
    
    ## To cleanup after test:
    kubectl delete daemonset panic-reboot-test 